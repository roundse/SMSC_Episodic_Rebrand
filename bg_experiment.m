function [avg_checks side_pref checked_places] = bg_experiment(cycles, ... 
    learning_rate, gain_oja, is_disp_weights)

global INP_STR;
INP_STR = 2;
global GAIN;
GAIN = 5;

%global learning_rate;
%learning_rate = 0.084; 

global HPC_SIZE;
HPC_SIZE = 250;                 % 2 x 14 possible combinations multipled
                                % by 10 for random connectivity of 10%
global FOOD_CELLS;
global PLACE_CELLS;
FOOD_CELLS = 2;
PLACE_CELLS = 14;

EXT_CONNECT = .2;                   % Chance of connection = 10%
INT_CONNECT = .2;

global VALUE;

global worm;
global peanut;
worm = 1;
peanut = 2;

global PEANUT;
global WORM;
WORM =  [-1, 1];
PEANUT =[1, -1];

global place;
place = zeros(length(PEANUT), PLACE_CELLS);

% Weight initialization
global w_food_to_hpc;
global w_place_to_hpc;
global w_hpc_to_food;
global w_hpc_to_place;
global w_hpc_to_hpc;

global w_food_to_food;
global w_food_in;

global hpc_in_queue;
global hpc_weight_queue;
global food_in_queue;
global food_weight_queue;

global place_in_queue;
global place_weight_queue;

global hpc_responses_to_place;

global is_learning;
is_learning = 1;

place_in_queue = {};
place_weight_queue = {};

hpc_in_queue = {};
hpc_weight_queue = {};

food_in_queue = {};
food_weight_queue = {};

w_food_in = eye(FOOD_CELLS);
w_food_to_food = zeros(FOOD_CELLS);

w_food_to_hpc = 0.3 .* (rand(FOOD_CELLS, HPC_SIZE) < EXT_CONNECT);
w_hpc_to_food = -w_food_to_hpc';
w_place_to_hpc = 0.3 .* (rand(PLACE_CELLS, HPC_SIZE) < EXT_CONNECT);
w_hpc_to_place =  -w_place_to_hpc';

% good weight test
% w_food_to_hpc = [1.78455196877048,0,0,1.78456252655919,0,0,0,0,0,0,0,0,1.78455693627048,0,0,0,0,0,0,1.78455957370860,1.78449066147715,0,0,0,0,0,0,1.78456443537609,1.78456432329540,0,1.78456447055322,0,0,0,0,0,0,0,0,1.78456406144392,1.78456089406340,0,0,0,0,0,1.78456339800150,0,0,0,0,0,0,0,0,-0.324870372604130,0,0,-0.324854927862328,0,0,1.78456448355911,1.78456423232039,0,-0.324859120069037,0,0,0,0,0,0,1.11857825254993,0,0,0,0,1.78064058907819,1.11853964218338,-0.324858719078444,0,1.78393003012919,0,0,0,0,0,0,0,0,0,1.78455864035645,0,0,0,0,0,0,0,1.78441898669260,0,0,1.78456325791205,0,0,0,0,-0.324855456922334,0,0,0,0,0,0,0,0,0,1.11856901388336,1.78455432916801,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.11848797311228,0,0,1.78456440459675,0,0,0,0,1.78456340761600,0,0,0,0,-0.324853807247688,0,0,1.78447780748422,0,0,1.78456436353510,0,0,0,0,0,1.11857614836364,0,0,0,1.11855111521595,0,1.11859400869444,0,0,0,-0.324873033471864,0,-0.324857373335176,0,0,0,0,1.78453896594609,-0.324855172994771,0,1.78456445761360,0,1.78456448842649,0,0,0,0,0,0,0,0,0,0,1.78455436516591,0,0,0,1.11852708830954,1.11811566033050,1.78451603577138,0,0,0,0,0,0,0,0,0,0,1.78456440324714,0,1.77754932503949,0,0,1.78452325141531,0,0,0,-0.324876811946552,0,0,0,0,-0.324857090469560,0,0,1.78456439800713,0,0,0,0,0,0,0,0,1.78456440462683,0,1.78252004656657,0,0,0,0,0,0,1.11856795326538,-0.324862112445956,0,0,0,0,-0.324854513539952;0,0,5.13800001480991,0,0,0,5.13799967518685,0,0,0,0,0,0,0,5.13800001482000,5.13800001480991,0,0,0,0,0,0,0,0,0,5.13800001480803,0,0,0,5.13799974234420,0,0,0,0,0,0,5.13799174277602,0,5.13800001480986,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5.24870737475909,0,0,5.24870211168758,5.13799494456768,5.13800001547775,0,0,0,5.24870354028243,0,5.13800001480991,0,0,0,0,0,0,0,0,0,0,0,5.24870340363534,0,0,5.13799974273356,5.13800001480987,0,0,0,0,0,0,0,0,0,0,0,0,5.13799968763704,0,0,0,5.13800001480991,0,0,0,0,0,0,5.24869683389685,0,0,0,0,5.13799995447329,0,0,0,0,0,0,0,5.13800001480459,0,0,0,0,0,0,5.13800001490457,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5.09619595535299,0,5.24870172977728,0,0,0,0,0,0,0,0,0,0,0,0,5.13799996853318,0,0,0,0,0,5.13800001480656,5.13800001563057,0,5.24870828160774,0,5.24870294504103,0,0,0,0,0,5.24870219093008,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5.13800001529392,5.13799967277236,0,5.13800001480968,0,0,5.13799994584862,0,0,0,0,5.24870962213309,0,5.13799999836034,0,5.13800001480907,5.24870284864734,0,0,0,0,5.13800001480991,0,0,0,5.13800001299798,0,0,0,0,0,0,0,0,0,5.13800001480956,0,0,5.24870456000637,0,5.13800001480991,0,0,5.24870196926213;];
% w_food_to_hpc(w_food_to_hpc~=0) = 0.3;
% w_hpc_to_food = w_food_to_hpc';
% w_place_to_hpc = [0,-0.00374999999994891,0,0,0,0,0,0,-0.185999999999920,0,0,0,0,0,0,0,0,0,0,-0.125249999999938,-0.185275711802608,0,0,-0.165113534480374,-0.0326484190734060,-0.00374999999994891,0,0,0,0,0,0,0,0,-0.165113534480374,0,0,0,0,0,0,-0.0326484190734072,0,-0.0644999999999319,0,-0.00374999999994891,0,0,0,0,-0.0248189705991710,-0.185999999999920,0,0,-0.246749999999915,0,0,0,0,0,-0.00374999999994891,0,-0.0449811479214056,0,0,0,0,0,0,-0.00374999999994891,0,0,0,0,-0.00374999999994891,0,0,0,0,-0.246749999999915,-0.185275711802608,0,0,0,0,0,0,0,0,-0.165113534480374,-0.00374999999994891,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.185999999999921,0,0,0,0,-0.0248189705991710,0,-0.0124862417511725,0,-0.185999999999921,0,-0.165113534480374,0,-0.185999999999920,0,0,0,-0.125249999999938,0,-0.125249999999926,-0.0644999999999432,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.00374999999994891,0,0,0,0,0,-0.0326484190734072,0,0,0,0,0,0,0,-0.0248189705991710,0,1.11857614929712,0,-0.00374999999994891,0,0,0,0,-0.0644999999999432,0,0,0,1.11814474364277,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.125249999999926,0,0,0,0,0,0,-0.0644999999999432,0,0,0,0,0,-0.246749999999915,0,0,0,0,0,-0.307499999999909,-0.125249999999926,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0644999999999319,-0.00374999999994891,-0.00465679327693630,0,0,0,0,0,0,0,0,-0.0644999999999319,-0.00465679327690727,0,-0.00374999999994891,0,0,-0.185999999999921,0,0,-0.00374999999994891;0,0,0,0,-0.00374999999994891,0,0,0,0,0,0,0,0,0,0,0,-0.0644999999999432,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0449811480998692,0,0,0,0,0,0,0,0,0,-0.00374999999994891,0,0,0,0,-0.0302475992005078,0,0,0,-0.185999999999921,0,0,0,-0.246749999999915,-0.0253162499999908,0,0,0,0,0,-0.0100854218505762,0,0,0,0,-0.0326484193592778,0,0,0,0,0,0,-0.165113534823864,0,0,0,-0.0644999999999432,0,-0.307499999999909,-0.0253162499999908,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.00374999999996023,0,0,-0.125249999999926,0,0,0,0,-0.164217381874417,0,0,0,-0.125249999999926,0,0,0,0,-0.171192504456278,0,0,0,-0.184379559224348,0,-0.0644999999999319,0,0,0,-0.0782199181216212,0,0,0,-0.165113534823864,0,0,0,-0.0644999999999432,0,0,0,0,-0.125249999999938,0,0,0,-0.0326484193592778,-0.125249999999926,0,0,0,-0.185999999999921,0,-0.125249999999938,0,0,-0.0644999999999319,0,0,0,0,0,0,-0.165113534823864,0,0,0,0,0,1.87736897910430,-0.00374999999994891,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.246749999999915,-0.0248189707499377,-0.0326484193592778,0,0,0,0,0,0,0,-0.125249999999938,0,0,-0.0326484193592778,0,0,0,0,0,0,-0.0253162499999908,0,0,0,0,-0.0644999999999319,0,-0.0580577407716897,0,0,0,0,0,0,0,0,0,0,0,-0.0644999999999432,-0.0644999999999319,0,1.81230810296651,0,0,0,0,0,0,0,-0.0302475992004072,0,0,0,0,-0.185999999999921,-0.246749999999915,0,0,0,2.02076221475877,1.81845953225442,0,0,0,0,0,-0.0248189707499377,0,0;0,0,0,0,-0.386744352161699,0,0,0,-0.624174029585093,0,0,0,-0.115926974817032,0,0,0,0,0.689583951980932,0,-0.0692879900380348,0,0,0,-0.0419128033835334,0,0,0,0,0,-0.146603673072012,0,-0.336859012221993,0,0,0,0,0,0,-0.112166185005493,0,0,0,0,0,0,0,-0.386279520212324,0,0,-0.708755739929187,0,0,0,0,-0.00775584069761057,0,0,0,0,0,0,-0.385407157083955,0,0,0,0,-0.102485823393748,0.685704846015069,0,0,0,0,0,0,0,0,0,0,-0.109743293675827,0,0,-0.0161287350549125,0,0,0,0,0.686460695645738,0,0,-0.0434107193064055,0,0,0,0,0,0,-0.0600045556681526,0,0,0,-0.396944306282716,0,-0.149836740904014,0,-0.604922328601862,0,0,0,0,0,0,0,0,0,0,-0.290907779868194,0,-0.220917798910948,-0.0353744497980371,0,-0.122111213313319,0,0,0,0,0,0,0,0,0,0.685616630588153,0,-0.0230547203717664,-0.385986767485986,0,-0.0136513285838044,0,-0.0616003922702998,0,-0.0136513285838780,0,0,0,0,0,0,-0.0353744497980371,0,0,0,0,0,0,0,0,-0.122920135135855,0,0,0,0,0,0.685551511752011,-0.129435290552722,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0861171371121328,0,0.945623245580039,0,0,0,0,0,0,0,0,-0.668146601484658,0,-0.146563888625452,0,0,0,0,0,0,0,0,0,0,0,0,0,0.685575708382573,0,0,0,-0.222285058294059,-0.386136574155552,0,0,0,0,0,0,-0.388756054730143,0,0,0,0,0,-0.0274719924792117,0,0,-0.396751219996616,0,0,0,0,0,0,0,0,0,0,0,-0.0730142402375004,0,0,0.690033686923461,0,0,0,0,0.824453088148416,0,0,0,0,0;0,0,0,0,0,0,0,0,0,-0.0865998892361002,0,0,0,0,0,0,0,0,0,0,-0.487642643982329,0.886299452671267,0,0,0.919720107727166,0,0,0,0,0,0,0,-0.0230547203717636,0,0,0,-0.444965422855304,0,0,0,0,0,-0.149836740903932,0,0,0,0,0,-0.157957295239648,0,0,0,0,-0.0537685254943740,0,0,0,0,-0.0136513285838761,0,0,0,0,0,-0.00292629701756855,0,0,0,0,0,-0.0136513285838761,0,0,-0.000317164322881758,0,0,0,0,0,0,-0.0310271260791552,-0.0293094519880053,-0.0873055404518873,0,0,0,0,0,0,0,0,-0.598996583041914,0,0,-0.00111347931045713,0,0,0,-0.0808461070135083,-0.281668947021245,0,0,-0.219723731050732,0,0,0,0,0,0,0,0,0,-0.0136513285838761,0,0,0,0,0,0,0,0.973830176645795,0,0,0,0,0,0,0,-0.0109001050109709,0,0,0,0,0,0,0,-0.0780879043847261,0,0,-0.0148443490982689,0,0,0,0.886273064884023,0,-0.441238330810168,0,0,0,0,0,0,0,0,0,0.977358379427148,0,0,0,0,0,0,0,0,-0.0768165194525320,0,0,0,0,0,0,0,0,0,0,0,-0.242292042249470,0,0,0,-0.0662823057007645,0,0,0.886288439775610,0,-0.0616003922702963,0,0,0,0,0,0,0,0,0,0,0,-0.105362851855323,0,0,0,-0.0353744497980350,0,0,-0.00869264701855910,0,0,0,0,0,0,0,0,-0.0252747890071002,0,0,0,0,0,0,0,-0.295185423641514,0,-0.108435499808764,0,-0.0423004351148874,0,0,0,0,0,0,0,0,0,-0.452108498945720,0,0,0,0,0,0,0,0,0,0,0,0,-0.0861171371121997,0;0,0,0,0,0,-0.0282919699203530,0,-0.108125737726499,-0.248384833961123,0,0,0,-0.0979637554271948,0,-0.0302338227367442,0,-0.401325189656461,0,0,-0.385532856249892,0,0,-0.0494795374798682,0.774487500673708,0,0,0,0,0,0,0,0,0,-0.0708373541671362,-0.0298799103939954,0,0,0,0,0,-0.175301820129884,0,0,0,0,0,0,0,-0.0163977290739566,0,0,0,0,0,0,0,0,0,0,0,0.454354527123252,0,0,0,0,0.486103993345222,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0144877752344303,1.91494395504966,0,0,0,0,0,0,0,0,0.700678757110753,0,0,0,0,0,0,-0.108822303652446,0,-0.0792396646721499,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.115475667571653,0,0,0,0,0,0,-0.0458979645398869,0,0,0,0,0,0,-0.451243006953146,0,0,-0.0136513285838043,0,-0.358197537173169,-0.337307631600430,0,0,0,-0.149397070710841,-0.0936431512095092,0,0,-0.308916917651302,0,0,0.508615796983064,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.404225089997633,-0.0177836987610279,-0.0884552687562372,0,0,-0.0186441129955386,-0.0616003922702998,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.484592730508568,0,0,0,-0.441749436200366,0.462595034289299,0,-0.00775584069761395,0,0,0,0,0,0,0,0,-0.0423546775272641,0,0,0,0,0,0,0,0,-0.0467177072223361,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.00482993540888041,0,0,0,0,0,0,0,0,-0.411578566656769,-0.0382094707296235;0,0,0,0,0,0,-0.142396398987061,0,0,-0.143658066562229,0,1.18836729288585,0,0,0,1.12369072239354,0,0,-0.00292629701756983,0,0,0,0,0,0,1.20372867512917,0,0,0,0,0,0,0,0,1.29807448811892,0,0,1.19609586398628,1.14266067853407,1.96704437146753,0,1.15070723121330,1.46553759480523,0,0,0,0,0,0,0,0,0,0,0,-0.0227185393137559,0,0,0,-0.0674691266757431,0,0,0,0,1.11805670017709,0,0,0,0,0,0,1.21785498567841,0,0,0,0,0,-0.0190006464249573,0,1.40235443197450,-0.0907971463855471,0,0,0,0,1.19507275455791,0,0,0,0,0,1.81045132831286,0,1.19645045508410,0,0,0,1.18554242448653,0,0,0,0,0,0,0,1.52786672086171,-0.136436793137583,0,0,0,0,0,0,-0.00839875000842801,1.45095939110280,0,1.34712761850535,0,0,-0.0157776695991227,0,0,-0.0588421897220166,0,0,0,0,0,1.25963153001914,1.11806550986322,0,0,1.34710690500414,0,0,0,0,0,0,1.11805638406207,0,1.11810712025438,0,0,0,0,0,1.17024375979047,-0.0686334713407445,0,0,0,-0.0136513285838788,0,0,-0.0353744497979840,0,0,1.25983786992266,0,1.18414194940010,0,0,0,0,0,0,0,1.82645061207016,0,0,0,1.22524578915452,0,0,0,-0.0687252522229922,0,0,0,0,0,0,0,0,0,1.12124380207216,0,0,0,-0.0100916209305780,0,0,0,0,1.23117598274448,0,0,2.01130996049494,0,0,0,1.18763028657120,0,0,1.11815452594326,0,-0.0904975791302445,0,0,1.22723966773227,0,0,0,0,0,1.20352401927314,0,0,-0.0736137922967203,-0.111320095833522,0,0,0,0,0,0,0,1.11800176678886,0,0,0,0,0,-0.0136513285838044,0,0,0,0,0,0,0,0,0,0,0,0,1.56135510772040,0,-0.0857357115507035,0;0,-0.101489584917971,0,0,0,0,0,0,0,-0.00770113396937888,0,0,0,0,0,0,-0.0733099378136770,0,0,-0.0587298591732398,0,0,0,0,0,0,0,-0.101657071752818,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0933334470001567,0,0,0,0,0,-0.0342992349740444,-0.0148671114141595,0,0,0,-0.233357665446472,-0.0844209993694777,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0421501145125228,0,-0.0833725985809685,0,0,0,0,0,0,0,-0.100885479041099,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0494795374796762,0,0,0,0,0,0,0,0,0,0,-0.221949533272958,0,0,0,0,0,0,0,0,0,0,0,0,-0.0768298636814276,-0.0785065561677382,0,1.29962006135100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0423004351146278,-0.0420291668041182,-0.0718996019558668,0,0,0,0,0,-0.0999509016686652,0,-0.0110985044421909,0,0,0,0,0,0,0,0,-0.0764682817792615,0,0,1.11777602370434,0,-0.0975030942880246,0,0,0,-0.233734509754460,0,0,0,0,-0.00315531155000770,0,0,0,-0.244792153011054,-0.0686334713404654,0,0,0,0,-0.0959602417686661,0,0,0,0,-0.246694999975268,0,0,0,0,0,-0.377927221989601,0,0,0,0,0,0,0,0,0,0,-0.307970976749906,0,0,0,0,0,0,0,0,0,0,0,0,1.12156403368290,0,0,-0.0837511447045074,1.78424102324640,-0.0528525531665953,-0.185310680674391,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0275943749999489,0,0,0,0,1.88621186684817,0,0,0,0,0,0,0,-0.0326484193593571,0,-0.0436551396205449,0,0,0,0,0,1.23644868720804,0,0,0,0,0,0,0,-0.171192504456349,0,-0.0241089993555570,0,-0.0248189707499795,-0.0248189707499795,0,0,-0.00374999999994891,0,0,0,0,-0.0821934374999337,0,0,0,0,0,0,0,0,0,0,0,-0.0170117154223792,0,-0.0654702074126962,1.61101097686535,0,-0.0373920081214452,0,0,-0.0436551396205449,0,0,-0.136792499999929,0,0,0,1.11839014417263,0,0,0,-0.0324956264846208,0,0,0,0,1.20534676155303,0,0,0,0,0,0,0,0,0,-0.0275943749999489,0,1.12646684752491,0,0,0,0,0,0,1.19122402720559,0,0,0,0,0,0,0,0,0,1.11805765771703,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0435686591482924,-0.0677978617506914,0,0,0,0,0,0,-0.0435686591483446,0,0,0,0,-0.0324956264845704,0,0,-0.0434963519530746,0,0,0,0,0,0,0,0,0,0,0,0,-0.0275943749999490,0,0,0,0,0,0,0,0,0,0,-0.00374999999994891,0,0,0,0,0,-0.00374999999994891,0,0,0,0,0,0,0,0,-0.0435686591482931,0,0,0,0,0,0,0,0,0,0,-0.00465679340004024,0,0,0,0,1.42594318685263,-0.0925672593749357,0,0,-0.0925672593749358,0,0,0,-0.0464260680130381,0,0,0,1.28904410039954,0,0,0,0,0,1.20070512422482,0,0,0,0,0,0,0,0,0,0,-0.0422597606270295,0,1.40915446742328,0;0,1.22328554455783,-0.00465679340004024,1.78456261074357,0,0,-0.0324956264845704,-0.0436551396205449,0,0,0,0,0,0,0,0,0,0,-0.0821934374999337,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.15339801726177,0,0,1.11822988430191,0,0,0,1.87201468916142,0,0,-0.0538902092276722,0,0,1.86948419924985,0,-0.0135899416532908,0,1.14287757457410,0,1.11805764515005,1.63704182060839,0,1.14282073733342,0,0,0,-0.0100854218481226,0,0,1.82954546522412,0,0,0,0,0,0,-0.0302475992005870,0,0,0,0,0,-0.00374999999994891,0,-0.0528105967092963,0,0,0,1.15895458438022,0,0,0,0,0,-0.0412857532361781,-0.00374999999994891,0,0,0,-0.0436551396205449,0,0,0,0,0,0,-0.0619541339785893,0,0,0,0,0,-0.0821934374999438,-0.0326484193593571,0,-0.0850107188820130,1.15920597885251,0,0,0,-0.00886141565581516,0,0,0,0,-0.0435686591482924,-0.0731443487383090,0,1.56614494276431,0,0,-0.00585220231043737,1.11805978819281,-0.00465679340004024,0,0,0,0,0,-0.0352665548770620,0,0,0,2.16627731481757,0,0,1.12106673717636,0,-0.00154210841680817,0,0,0,0,-0.000896521358573543,0,0,0,0,0,0,0,0,0,0,0,0,-0.0336445564362852,0,0,1.25517881824251,0,0,0,1.12687315172646,0,0,0,1.12730236872771,0,1.11805748684269,0,0,0,1.23455191886632,-0.0326484193593571,0,0,0,0,0,0,0,0,-0.0302475991980619,-0.00776122989743766,-0.165113534823960,0,-0.0677978617508500,0,0,0,0,-0.136792499999929,0,-0.00637343334015145,0,0,0,-0.0259269204082005,-0.0248189707499795,0,0,-0.0457802625084310,0,0,0,0,0,0,1.12265856017562,1.78453630629063,0,0,-0.0326484193593571,0,0,0,0,-0.00649726918593785,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0302856503824127,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,1.12265856018890,0,0,0,0,0,0,0,0,-0.0703080529718762,-0.0300984358506205,0,-0.0275943749999489,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0528105967092963,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0326484193593571,0,-0.161458770680107,0,0,0,0,0,0,1.14287680674563,0,0,0,0,0,0,0,-0.175131532775522,0,0,0,0,0,0,0,0,0,-0.0302475992005870,0,0,0,0,0,0,0,1.11804652514328,0,0,0,0,1.42402196814022,0,0,0,0,0,1.11805718407337,0,1.25137317029997,0,0,0,0,0,0,0,0,-0.0906226654095677,-0.0571810313502739,0,0,1.26533635855655,0,0,0,0,0,0,0,0,2.07694905570905,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.20334441461452,1.20187352512468,1.19955921628774,0,0,0,0,0,0,1.16852249014835,0,0,-0.0729038534084636,0,0,0,0,0,0,-0.0464260680131765,0,0,0,0,0,0,0,1.22174772549519,0,0,0,0,0,0,0,-0.00374999999994891,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.00585220231043734,-0.0485846232121337,0,0,0,0,0,0,0,0,0,0,-0.0592935564493416,1.29218957429481,0,0,0,0,0,0,0,0,0,0,0,0,-0.0447284316171229,0,0,-0.121760391168250,1.20528102941884,0,0,0,0,0,0,0,1.11805480630176,0,0,-0.0293452054436198,0,0,-0.00374999999994891,0,-0.0538948360742639,0,1.11805479537581,0,0,0,-0.177999114553126,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,1.88899521037506,-0.429692646790424,-0.0474096314680831,0,0,0,0,0,0,0,-0.360946793509051,0,0,0,0,0,1.83735875662440,0,0,1.19210017056159,0,0,0,1.15068689934193,0,0,0,0,0,0,-0.254080682199118,0,0,0,0,1.15069221663678,0,0,0,-0.572422227408991,0,-0.243546927912042,0,0,0,-0.329957450875732,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.229935170149245,0,1.15203743568328,0,1.81671540034968,0,-0.136117349377489,0,0,0,0,0,0,1.16027615213382,0,-0.0445226058873772,-0.420587517749481,0,0,0,0,0,0,0,0,0,1.82397326026922,0,0,0,-0.159909844844221,0,0,-0.162470376046201,0,0,-0.0620083015446382,0,-0.363457587867209,0,0,0,0,0,0,0,0,0,0,0,0,-0.317121159650140,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.168356111713802,0,0,0,-0.400762331939477,0,1.16006547112461,0,0,0,0,0,0,0,0,-0.0535791319768928,0,0,0,0,0,0,0,0,0,0,0,0,-0.339615001404819,0,1.15068772053249,0,0,0,0,1.11808426845428,0,0,0,1.15203941437621,0,-0.230059902680479,-0.170462015055252,-0.171901651074779,-0.334904958556199,0,0,-0.0427665446187804,0,0,0,0,0,-0.147818994625133,0,0,0,0,0,-0.0556499228619468,0,0,-0.0881104555506579,0,0,0,0,0,0,1.15068865902469,0,0,-0.319004970441258,0,0,0,-0.226589154198480,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.419714742234096,0,0,0,0,-0.401879358687025,0,0,0,0,0,0;0,0,0,0,0,0,0,1.21546731721917,-0.0568744130637142,-0.00871734631782578,0,0,0,1.54755684025789,0,0,0,0,-0.109104347538074,2.17590200816596,0,0,1.53122316257376,0,0,-0.0819821708030052,0,0,0,1.15004949495299,1.78439996911529,0,-0.0352665548770634,0,0,0,0,-0.0343836173636066,0,0,0,0,0,0,1.11785854481600,0,0,0,0,0,0,2.10255055577829,0,0,1.47349543361333,0,0,0,0,0,0,0,0,0,1.37516126208080,0,0,0,0,0,-0.0997965167689826,0,0,1.11786194909703,0,0,0,0,-0.00656047310050811,0,0,0,0,1.11786131566885,-0.0333613568562597,0,0,0,0,0,-0.0221440231298008,0,-0.0347404073631729,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.11792242953238,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0326484193593571,1.56034338266062,0,0,1.12248130861963,0,0,0,0,-0.00386505531405106,0,0,0,0,0,0,0,0,0,1.86058066169129,0,0,0,1.34534312117064,0,0,0,0,-0.0210969009660700,0,0,0,0,0,1.14267869368059,0,0,0,0,0,0,0,0,1.41445263310228,0,0,-0.0302475991980619,0,0,0,0,0,0,2.22026235134432,0,0,0,0,-0.0281251273296701,0,0,0,0,0,0,0,0,0,0,2.11924407504878,0,0,0,0,0,0,0,0,1.76329604643315,0,0,0,0,0,2.01306875280581,0,1.86921992107505,0,0,0,0,0,-0.00374999999994891,0,0,0,-0.00791079935327804,0,0,1.22307579667240,0,0,0,0,0,0,0,-0.106492706516315,0,1.12248130821475,0,0,0,0,2.04496584417242,0,1.54133304289439,0,0,0,0,1.52398357874047,0,0,0,0,0,0;1.78433002617017,0,0,0,0,1.13198064100755,0,0,0,0,0,0,0,0,0,-0.00568932079414355,0,0,0,0,1.96979027943341,0,0,0,0,0,0,0,0,0,0,0,1.15319054907831,0,0,0,0,0,0,-0.182491938675275,0,0,0,0,0,1.12176511332041,0,0,1.17400786251299,0,0,-0.0550493288275876,0,0,0,0,0,1.44782944009196,0,1.13166010084048,0,0,0,0,0,0,0,0,0,1.15186101497706,0,0,1.34800551551740,0,0,-0.181667683962099,0,1.17113064904792,-0.0517127628384280,-0.148157720128281,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.127821847590265,1.31095729824712,0,0,1.55615196592152,1.15047386879383,0,0,0,0,1.13031086503576,0,-0.137843350164646,1.11787937690211,0,-0.126686009880448,0,0,0,0,-0.0420685849390637,1.15056419232020,0,1.21112271737203,0,0,-0.141372220707407,0,0,0,0,1.15819497553610,0,0,0,-0.202848056234521,0,0,0,0,0,0,0,0,0,0,1.42281565849761,0,0,0,0,1.87306947670310,0,0,0,0,-0.141590645919263,0,0,0,0,0,0,0,-0.0304489769903457,0,0,1.15182186496516,0,0,0,0,0,0,0,0,0,0,0,-0.0393312395553254,0,0,0,0,0,0,0,1.51304295046318,0,1.44270211541278,0,-0.182154835915932,0,0,-0.00386091953748979,0,0,0,0,0,0,0,0,0,0,-0.00436843157788130,0,0,0,0,1.11785940717581,0,0,-0.181357551479638,0,0,0,0,0,0,0,0,1.46627101933999,0,1.83079109123148,0,0,1.11785577137826,0,0,0,0,0,0,0,-0.0307123719933901,0,0,0,0,0,0,0,0,0,-0.0370968514639010,0,0,0;0,0,0,0,1.20287691296459,0,1.29272340789840,0,1.62192777813448,1.27798252791469,1.11785850747561,0,0,0,1.20791458307596,0,1.39207263017208,0,1.31209203817179,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.45022315336112,0,0,0,0,0,0,0,0,1.18530278081322,0,0,1.86905957630275,0,0,0,0,1.14035178141055,0,0,0,0,1.11835650392731,0,0,0,1.30327592997056,0,0,0,0,0,0,0,0,0,0,0,0,1.54220170045891,0,0,0,0,0,1.11785916385509,0,0,0,0,1.18007787473375,0,1.91216330364832,0,0,0,0,0,0,0,0,1.55839611387798,0,0,0,0,0,1.24503327448517,0,1.18498795302422,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.78425599654214,1.13907857436741,1.53230179357460,0,0,1.26870439823180,0,0,0,0,0,0,0,0,0,1.11841458843079,0,0,0,0,0,0,0,0,1.11788381043258,0,0,0,0,0,0,2.08587241931075,1.11789480691015,0,0,1.11786290247893,0,0,1.39774283849017,0,1.57542380918413,0,0,1.30377221131936,0,0,1.40350829383639,0,0,0,0,0,0,1.14267917425369,0,0,1.16372377087530,0,0,0,0,0,0,0,0,1.30296787371301,0,0,0,1.31526644771940,1.54824205481855,1.16267602934570,0,0,0,0,0,0,0,0,0,0,0,0,1.21528482660171,0,0,0,0,0,0,0,0,0,0,0,1.11790595120606,0,1.11789869002972,0,1.14063791157774;];
% w_place_to_hpc(w_place_to_hpc~=0) = 0.3;
% w_hpc_to_place =  w_place_to_hpc';

global w_hpc_to_place_init;
global w_place_to_hpc_init;

w_hpc_to_hpc = 0.5 .* (rand(HPC_SIZE, HPC_SIZE) < INT_CONNECT);
w_hpc_to_place_init = w_hpc_to_place;
w_place_to_hpc_init = w_place_to_hpc;

global hpc;
global place_region;
global food;

hpc = zeros(cycles, HPC_SIZE);
food = zeros(cycles, FOOD_CELLS);
place_region = zeros(cycles, PLACE_CELLS);
hpc_responses_to_place = zeros(PLACE_CELLS, HPC_SIZE);

global PLACE_SLOTS;

PLACE_SLOTS = zeros(PLACE_CELLS);

PLACE_STR = 0.4;

% Food is pre-stored.
for i = 1:PLACE_CELLS
    if i <= 7
        place(:,i) = WORM;
        PLACE_SLOTS(i,:) = 3*(rand(1, PLACE_CELLS) < PLACE_STR);
    else
        place(:,i) = PEANUT;
        PLACE_SLOTS(i,:) = 3*(rand(1, PLACE_CELLS) < PLACE_STR);
    end
end

% 'good' place 
% PLACE_SLOTS = [3,3,0,0,3,0,0,0,3,3,3,3,0,0;3,3,0,0,3,3,0,0,0,0,0,3,0,3;0,3,0,3,0,3,3,3,0,0,0,3,0,3;0,3,3,3,0,0,0,0,0,0,0,0,0,3;0,0,0,0,3,0,0,3,3,0,3,0,3,3;3,3,0,0,0,0,0,3,3,3,0,3,0,3;0,0,0,3,3,0,0,3,3,0,0,3,0,3;0,0,0,3,0,0,0,0,3,3,0,3,0,0;3,0,0,0,0,0,0,0,0,3,0,3,0,0;0,3,3,0,0,3,3,0,0,0,3,3,0,0;0,0,0,3,3,0,0,3,3,3,0,0,3,0;3,3,0,0,3,3,3,0,3,3,0,0,3,3;3,0,0,0,0,3,0,3,3,3,3,0,0,0;0,3,3,3,0,0,3,3,0,0,0,0,3,3;];
% 'bad' place 
% PLACE_SLOTS = [0,0,3,3,0,0,0,0,0,3,0,0,3,0;0,0,0,3,0,0,3,0,3,3,3,3,0,0;0,0,3,3,3,0,3,0,0,0,0,0,3,0;3,0,0,0,3,0,0,3,3,3,0,0,0,0;3,3,3,0,0,3,0,0,0,3,3,3,3,0;0,0,3,0,0,0,3,0,3,0,0,3,0,3;0,3,0,0,0,0,3,3,3,3,0,3,0,3;3,0,3,3,0,0,3,0,3,0,0,0,3,0;0,0,0,0,3,3,0,0,3,3,3,3,0,3;3,3,3,0,3,0,0,3,0,3,0,0,0,3;0,3,0,3,0,0,0,3,0,0,0,0,3,3;3,0,3,3,0,0,3,0,3,3,3,0,0,3;0,3,0,0,0,3,0,0,0,3,0,3,0,3;0,3,0,3,0,3,3,0,0,3,0,3,0,0;];
place = place';

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Task 1: Pre-store food in place slots
%         Have agent recover foods from places to learn food/place
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% given food without value
stored_val = VALUE;
VALUE = [1 1];
value = 1;

for k=1:1
    place_order = randperm(PLACE_CELLS);

    for j = 1:PLACE_CELLS % recover from all slots
        i = place_order(j);

        cycle_net(PLACE_SLOTS(i,:), place(i,:), cycles, value);
    end
end


for k=1:10
    place_order = randperm(PLACE_CELLS);

    for j = 1:PLACE_CELLS % recover from all slots
        i = place_order(j);

        cycle_net(PLACE_SLOTS(i,:), place(i,:), cycles, value);
    end
end

show_weights('No value', is_disp_weights);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Task 2: Agent stores food in place slots
%         Have agent recover foods from places, but this time with
%         value
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% given food with value
VALUE = stored_val;

for k=1:1
    place_order = randperm(PLACE_CELLS);

    for j = 1:PLACE_CELLS
        i = place_order(j);
  
        if place(i,:) == WORM
            value = VALUE(worm);
        else
            value = VALUE(peanut);
        end
        
        cycle_net(PLACE_SLOTS(i,:), place(i,:), cycles, value);
    end
end

% given food with value
for k=1:20
    place_order = randperm(PLACE_CELLS);

    for j = 1:PLACE_CELLS
        i = place_order(j);
  
        if place(i,:) == WORM
            value = VALUE(worm);
        else
            value = VALUE(peanut);
        end
        
        cycle_net(PLACE_SLOTS(i,:), place(i,:), cycles, value);
    end
end
show_weights('Cached with value ', is_disp_weights);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Task 3: Agent stores food in place slots
%         Have agent recover foods from places, see if it chooses
%         highest-value places.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
is_learning = false;
place_order = randperm(PLACE_CELLS);

for l=1:PLACE_CELLS
    i = place_order(l);

    food_stim = place(i,:);
    place_stim = PLACE_SLOTS(i,:);

    for j = 3:cycles
        hpc_out = hpc(j-1,:);
        place_out = place_region(j-1,:);
        food_out = food(j-1, :);

        % sets value
        if place(i,:) == WORM
            value = VALUE(worm);
        else
            value = VALUE(peanut);
        end

        cycle_place(place_out, eye(PLACE_CELLS), place_stim, value);
        cycle_place(place_out, w_hpc_to_place, hpc_out, value);

        cycle_food(food_out, eye(FOOD_CELLS), food_stim, value);
        cycle_food(food_out, w_hpc_to_food, hpc_out, value);

        cycle_hpc(hpc_out, w_place_to_hpc, place_out, value);
        cycle_hpc(hpc_out, w_food_to_hpc, food_out, value);

        cycle_hpc(hpc_out, w_food_to_hpc,  food_stim, value);

        hpc(j,:) = cycle_hpc(hpc_out, is_learning);
        place_region(j,:) = cycle_place({place_region(j-1,:), ...
            hpc(j,:)}, is_learning);
        food(j,:) = cycle_food({food(j-1,:), hpc(j,:)}, is_learning);
    end
    hpc_responses_to_place(i,:) = mean(hpc(3:cycles,:));
end

% agent thinks about stored food
collect_size = 10;
for k=1:collect_size
    place_order = randperm(PLACE_CELLS);
    
    for j=1:PLACE_CELLS
        i = place_order(j);
        
        food_stim = place(i,:);
        place_stim = PLACE_SLOTS(i,:);

        for j = 3:cycles
            hpc_out = hpc(j-1,:);
            place_out = place_region(j-1,:);
            food_out = food(j-1, :);

            % sets value
            if place(i,:) == WORM
                value = VALUE(worm);
            else
                value = VALUE(peanut);
            end

            cycle_place(place_out, eye(PLACE_CELLS), place_stim, value);
            cycle_place(place_out, w_hpc_to_place, hpc_out, value);

            cycle_food(food_out, eye(FOOD_CELLS), food_stim, value);
            cycle_food(food_out, w_hpc_to_food, hpc_out, value);

            cycle_hpc(hpc_out, w_place_to_hpc, place_out, value);
            cycle_hpc(hpc_out, w_food_to_hpc, food_out, value);

            cycle_hpc(hpc_out, w_food_to_hpc, food_stim, value);

            hpc(j,:) = cycle_hpc(hpc_out, is_learning);
            place_region(j,:) = cycle_place({place_region(j-1,:), ...
                hpc(j,:)}, is_learning);
            food(j,:) = cycle_food({food(j-1,:), hpc(j,:)}, is_learning);
        end
        hpc_responses_to_place(i,:) = mean(hpc(3:cycles,:));
    end
end

% food is retrieved from store
is_learning = 0;
neutral_input = sum(PLACE_SLOTS);

testing_trials = 6;
hpc_place_responses = zeros(testing_trials,HPC_SIZE);
checked_places = zeros(testing_trials,14);
side_pref = zeros(testing_trials,2);
for k = 1:testing_trials
    bland_input = neutral_input/max(neutral_input) + rand(1,14)/2;
    
    for i = 1:PLACE_CELLS
        cycle_net(PLACE_SLOTS(2,:), [0.1 0.1], cycles, 0);
    end
    hpc_place_responses(k,:) = mean(hpc(3:cycles,:));
    checked_places(k,:) = find_place(hpc_place_responses(k,:));
    [side_pref(k, 1) side_pref(k, 2)] = side_preference(checked_places(k,:));
end

% if mean(side_pref(:, 1)) < 0.6
%     show_weights('Bad run, please inspect', 1);
%     disp(PLACE_SLOTS);
%     input('continue?');
% else
%     show_weights('Good run', 1);
% end

avg_checks = mean(checked_places);

figure;
title('Place dist');
plot(avg_checks);
drawnow;
end
